<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hub Documentale ‚Äî Viceconti</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap');

  :root {
    --bg:        #0f1117;
    --surface:   #181c27;
    --surface2:  #1e2335;
    --border:    #2a3050;
    --accent:    #4f9cf9;
    --accent2:   #38d9a9;
    --warn:      #ffa94d;
    --text:      #e2e8f0;
    --muted:     #6b7a99;
    --mono:      'IBM Plex Mono', monospace;
    --sans:      'IBM Plex Sans', sans-serif;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--sans);
    font-size: 14px;
    min-height: 100vh;
    line-height: 1.5;
  }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  header {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 0 20px;
    display: flex;
    align-items: center;
    gap: 16px;
    height: 54px;
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .logo {
    font-family: var(--mono);
    font-size: 13px;
    color: var(--accent);
    letter-spacing: 0.05em;
    white-space: nowrap;
    flex-shrink: 0;
  }
  .logo span { color: var(--muted); }

  .stats-bar {
    display: flex;
    gap: 16px;
    font-family: var(--mono);
    font-size: 11px;
    color: var(--muted);
    flex-shrink: 0;
  }
  .stats-bar b { color: var(--accent2); }

  .spacer { flex: 1; }

  .last-update {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--muted);
    white-space: nowrap;
  }

  /* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
  .tabs {
    display: flex;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 0 20px;
    gap: 4px;
  }

  .tab {
    padding: 10px 18px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    border: none;
    background: none;
    color: var(--muted);
    border-bottom: 2px solid transparent;
    transition: all 0.15s;
    font-family: var(--sans);
    display: flex;
    align-items: center;
    gap: 7px;
  }
  .tab:hover { color: var(--text); }
  .tab.active {
    color: var(--accent);
    border-bottom-color: var(--accent);
  }
  .tab-icon { font-size: 15px; }

  /* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
  .view { display: none; }
  .view.active { display: block; }

  /* ‚îÄ‚îÄ ALBERO ‚îÄ‚îÄ */
  #view-albero {
    max-width: 960px;
    margin: 0 auto;
    padding: 20px 16px;
  }

  .tree-search {
    position: relative;
    margin-bottom: 16px;
  }
  .tree-search input {
    width: 100%;
    padding: 10px 14px 10px 38px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-size: 14px;
    font-family: var(--sans);
    outline: none;
    transition: border-color 0.15s;
  }
  .tree-search input:focus { border-color: var(--accent); }
  .tree-search .search-icon {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--muted);
    font-size: 15px;
    pointer-events: none;
  }

  .tree-controls {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
  }
  .btn-sm {
    padding: 5px 12px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--muted);
    font-size: 12px;
    cursor: pointer;
    font-family: var(--sans);
    transition: all 0.15s;
  }
  .btn-sm:hover { color: var(--text); border-color: var(--accent); }

  /* nodi albero */
  .node { margin: 0; }

  .node-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 5px 8px;
    border-radius: 5px;
    cursor: pointer;
    user-select: none;
    transition: background 0.1s;
  }
  .node-header:hover { background: var(--surface2); }

  .node-toggle {
    width: 16px;
    height: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    color: var(--muted);
    transition: transform 0.2s;
    flex-shrink: 0;
  }
  .node-toggle.open { transform: rotate(90deg); }
  .node-toggle.leaf { color: transparent; }

  .node-icon { font-size: 15px; flex-shrink: 0; }

  .node-label {
    font-size: 13px;
    font-weight: 500;
    flex: 1;
    min-width: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .node-count {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--muted);
    flex-shrink: 0;
  }

  .node-children {
    padding-left: 24px;
    overflow: hidden;
    display: none;
  }
  .node-children.open { display: block; }

  /* livelli colore */
  .level-0 > .node-header .node-label { color: var(--accent); font-size: 14px; }
  .level-1 > .node-header .node-label { color: var(--text); }
  .level-2 > .node-header .node-label { color: var(--accent2); font-size: 12px; }
  .level-3 > .node-header .node-label { color: #c9d6f0; font-size: 12px; font-weight: 400; }

  /* riga documento */
  .doc-row {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 4px 8px;
    border-radius: 5px;
    text-decoration: none;
    color: var(--text);
    transition: background 0.1s;
    font-size: 12px;
  }
  .doc-row:hover { background: var(--surface2); }
  .doc-icon { font-size: 14px; flex-shrink: 0; }
  .doc-name { flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .doc-size { font-family: var(--mono); font-size: 11px; color: var(--muted); flex-shrink: 0; }
  .doc-tipo {
    font-family: var(--mono);
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 3px;
    background: var(--surface2);
    color: var(--muted);
    flex-shrink: 0;
  }

  /* ‚îÄ‚îÄ RICERCA ‚îÄ‚îÄ */
  #view-ricerca {
    max-width: 960px;
    margin: 0 auto;
    padding: 20px 16px;
  }

  .search-box {
    position: relative;
    margin-bottom: 8px;
  }
  .search-box input {
    width: 100%;
    padding: 14px 16px 14px 46px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-size: 16px;
    font-family: var(--sans);
    outline: none;
    transition: border-color 0.15s;
  }
  .search-box input:focus { border-color: var(--accent); }
  .search-box input::placeholder { color: var(--muted); }
  .search-box .search-icon {
    position: absolute;
    left: 14px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 20px;
    color: var(--muted);
    pointer-events: none;
  }

  .search-meta {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--muted);
    margin-bottom: 16px;
    padding: 0 4px;
    min-height: 18px;
  }
  .search-meta b { color: var(--accent2); }

  .results-list { display: flex; flex-direction: column; gap: 6px; }

  .result-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 14px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 7px;
    text-decoration: none;
    color: var(--text);
    transition: border-color 0.15s, background 0.15s;
    cursor: pointer;
  }
  .result-item:hover {
    border-color: var(--accent);
    background: var(--surface2);
  }

  .result-icon { font-size: 22px; flex-shrink: 0; }

  .result-body { flex: 1; min-width: 0; }
  .result-name {
    font-size: 14px;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .result-path {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--muted);
    margin-top: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .result-path .path-sep { color: var(--border); margin: 0 3px; }

  .result-right { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; flex-shrink: 0; }
  .result-tipo {
    font-family: var(--mono);
    font-size: 10px;
    padding: 2px 7px;
    border-radius: 3px;
    background: var(--surface2);
    color: var(--muted);
    border: 1px solid var(--border);
  }
  .result-size { font-family: var(--mono); font-size: 11px; color: var(--muted); }

  mark {
    background: rgba(79, 156, 249, 0.25);
    color: var(--accent);
    border-radius: 2px;
    padding: 0 1px;
  }

  /* ‚îÄ‚îÄ EMPTY / LOADING ‚îÄ‚îÄ */
  .placeholder {
    text-align: center;
    padding: 60px 20px;
    color: var(--muted);
  }
  .placeholder .big { font-size: 40px; margin-bottom: 12px; }
  .placeholder p { font-size: 13px; }

  .loading {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 40px;
    color: var(--muted);
    font-family: var(--mono);
    font-size: 13px;
  }
  .spinner {
    width: 16px; height: 16px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ‚îÄ‚îÄ ERRORE ‚îÄ‚îÄ */
  .error-box {
    margin: 40px auto;
    max-width: 500px;
    background: #1e1520;
    border: 1px solid #6b2737;
    border-radius: 8px;
    padding: 24px;
    text-align: center;
  }
  .error-box .err-icon { font-size: 32px; margin-bottom: 8px; }
  .error-box p { color: var(--muted); font-size: 13px; margin-top: 8px; }
  .error-box code { font-family: var(--mono); font-size: 12px; color: #ff8fa3; }

  /* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
  @media (max-width: 600px) {
    header { padding: 0 12px; gap: 10px; }
    .stats-bar { display: none; }
    #view-albero, #view-ricerca { padding: 12px 8px; }
    .result-right { display: none; }
    .doc-size, .doc-tipo { display: none; }
  }
</style>
</head>
<body>

<header>
  <div class="logo">VICECONTI <span>/</span> HUB DOCUMENTALE</div>
  <div class="stats-bar" id="stats-bar">
    <span>caricamento...</span>
  </div>
  <div class="spacer"></div>
  <div class="last-update" id="last-update"></div>
</header>

<div class="tabs">
  <button class="tab active" onclick="switchTab('albero')" id="tab-albero">
    <span class="tab-icon">üóÇ</span> Sfoglia
  </button>
  <button class="tab" onclick="switchTab('ricerca')" id="tab-ricerca">
    <span class="tab-icon">üîç</span> Cerca
  </button>
</div>

<div id="view-albero" class="view active">
  <div id="albero-content">
    <div class="loading"><div class="spinner"></div> Caricamento catalogo...</div>
  </div>
</div>

<div id="view-ricerca" class="view">
  <div class="search-box">
    <span class="search-icon">üîç</span>
    <input type="search" id="search-input" placeholder="Cerca cliente, attrezzatura, documento..."
           oninput="cercaLive(this.value)" autocomplete="off" spellcheck="false">
  </div>
  <div class="search-meta" id="search-meta">Digita per cercare in tutti i documenti</div>
  <div id="search-results" class="results-list">
    <div class="placeholder">
      <div class="big">üîç</div>
      <p>La ricerca trova clienti, attrezzature e nomi file<br>in tempo reale su tutto l'archivio</p>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ STATO GLOBALE ‚îÄ‚îÄ
let CATALOGO = null;
let TUTTI_DOCUMENTI = []; // flat list per ricerca

// ‚îÄ‚îÄ CARICAMENTO ‚îÄ‚îÄ
const CATALOGO_URL = 'catalogo.json?v=' + Date.now();

async function init() {
  try {
    const resp = await fetch(CATALOGO_URL);
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    CATALOGO = await resp.json();
    flattenCatalogo();
    renderStats();
    renderAlbero();
  } catch(e) {
    document.getElementById('albero-content').innerHTML = `
      <div class="error-box">
        <div class="err-icon">‚ö†Ô∏è</div>
        <strong>Impossibile caricare il catalogo</strong>
        <p>Assicurati che <code>catalogo.json</code> sia nella stessa cartella di questo file.</p>
        <p style="margin-top:8px"><code>${e.message}</code></p>
      </div>`;
  }
}

// ‚îÄ‚îÄ FLAT LIST per ricerca ‚îÄ‚îÄ
function flattenCatalogo() {
  TUTTI_DOCUMENTI = [];
  for (const c of (CATALOGO.comuni || [])) {
    for (const cl of (c.clienti || [])) {
      for (const area of (cl.aree || [])) {
        for (const attr of (area.attrezzature || [])) {
          for (const doc of (attr.documenti || [])) {
            TUTTI_DOCUMENTI.push({
              ...doc,
              _comune: c.comune,
              _cliente: cl.nome,
              _area: area.nome,
              _attrezzatura: attr.nome,
            });
          }
        }
      }
    }
  }
}

// ‚îÄ‚îÄ STATS ‚îÄ‚îÄ
function renderStats() {
  const bar = document.getElementById('stats-bar');
  bar.innerHTML =
    `<span><b>${CATALOGO.totale_comuni}</b> comuni</span>` +
    `<span><b>${CATALOGO.totale_clienti}</b> clienti</span>` +
    `<span><b>${CATALOGO.totale_file}</b> documenti</span>`;

  if (CATALOGO.generato) {
    const d = new Date(CATALOGO.generato);
    document.getElementById('last-update').textContent =
      'Aggiornato ' + d.toLocaleDateString('it-IT', {day:'2-digit',month:'2-digit',year:'numeric'}) +
      ' ' + d.toLocaleTimeString('it-IT', {hour:'2-digit',minute:'2-digit'});
  }
}

// ‚îÄ‚îÄ ALBERO ‚îÄ‚îÄ
function renderAlbero(filtro) {
  const container = document.getElementById('albero-content');
  const fl = filtro ? filtro.toLowerCase().trim() : '';

  const html = [];
  html.push(`
    <div class="tree-search">
      <span class="search-icon">üîç</span>
      <input type="search" placeholder="Filtra nell'albero..." oninput="renderAlbero(this.value)"
             value="${fl}" autocomplete="off">
    </div>
    <div class="tree-controls">
      <button class="btn-sm" onclick="espandiTutto()">‚ñº Espandi tutto</button>
      <button class="btn-sm" onclick="collassaTutto()">‚ñ≤ Comprimi tutto</button>
    </div>
  `);

  let trovatiAlcuno = false;

  for (const c of (CATALOGO.comuni || [])) {
    const comuneHtml = renderComune(c, fl);
    if (comuneHtml) { html.push(comuneHtml); trovatiAlcuno = true; }
  }

  if (!trovatiAlcuno) {
    html.push(`<div class="placeholder"><div class="big">üîç</div><p>Nessun risultato per "<b>${fl}</b>"</p></div>`);
  }

  container.innerHTML = html.join('');
}

function renderComune(c, fl) {
  const clientiHtml = [];
  let totDocComune = 0;

  for (const cl of (c.clienti || [])) {
    const r = renderCliente(cl, fl);
    if (r) { clientiHtml.push(r.html); totDocComune += r.count; }
  }

  if (!clientiHtml.length) return null;

  const aperto = fl ? 'open' : '';
  const id = 'c_' + slugify(c.comune);

  return `
    <div class="node level-0">
      <div class="node-header" onclick="toggleNode('${id}')">
        <div class="node-toggle ${aperto}" id="tog_${id}">‚ñ∂</div>
        <div class="node-icon">üìç</div>
        <div class="node-label">${hl(c.comune, fl)}</div>
        <div class="node-count">${clientiHtml.length} clienti ¬∑ ${totDocComune} doc</div>
      </div>
      <div class="node-children ${aperto}" id="${id}">
        ${clientiHtml.join('')}
      </div>
    </div>`;
}

function renderCliente(cl, fl) {
  const matchCliente = !fl || cl.nome.toLowerCase().includes(fl);
  const areeHtml = [];
  let totDoc = 0;

  for (const area of (cl.aree || [])) {
    const r = renderArea(area, fl, matchCliente);
    if (r) { areeHtml.push(r.html); totDoc += r.count; }
  }

  if (!areeHtml.length) return null;

  const aperto = fl ? 'open' : '';
  const id = 'cl_' + slugify(cl.nome);

  return {
    html: `
      <div class="node level-1">
        <div class="node-header" onclick="toggleNode('${id}')">
          <div class="node-toggle ${aperto}" id="tog_${id}">‚ñ∂</div>
          <div class="node-icon">üè¢</div>
          <div class="node-label">${hl(cl.nome, fl)}</div>
          <div class="node-count">${totDoc} doc</div>
        </div>
        <div class="node-children ${aperto}" id="${id}">
          ${areeHtml.join('')}
        </div>
      </div>`,
    count: totDoc
  };
}

function renderArea(area, fl, matchParent) {
  const matchArea = matchParent || !fl || area.nome.toLowerCase().includes(fl);
  const attrHtml = [];
  let totDoc = 0;

  for (const attr of (area.attrezzature || [])) {
    const r = renderAttrezzatura(attr, fl, matchArea);
    if (r) { attrHtml.push(r.html); totDoc += r.count; }
  }

  if (!attrHtml.length) return null;

  const aperto = fl ? 'open' : '';
  const id = 'a_' + slugify(area.nome + '_' + Math.random());

  return {
    html: `
      <div class="node level-2">
        <div class="node-header" onclick="toggleNode('${id}')">
          <div class="node-toggle ${aperto}" id="tog_${id}">‚ñ∂</div>
          <div class="node-icon">üîß</div>
          <div class="node-label">${hl(area.nome, fl)}</div>
          <div class="node-count">${totDoc} doc</div>
        </div>
        <div class="node-children ${aperto}" id="${id}">
          ${attrHtml.join('')}
        </div>
      </div>`,
    count: totDoc
  };
}

function renderAttrezzatura(attr, fl, matchParent) {
  const matchAttr = matchParent || !fl || attr.nome.toLowerCase().includes(fl);
  const docsHtml = [];

  for (const doc of (attr.documenti || [])) {
    const matchDoc = matchAttr || !fl || doc.nome.toLowerCase().includes(fl);
    if (!matchDoc) continue;
    docsHtml.push(renderDoc(doc, fl));
  }

  if (!docsHtml.length) return null;

  const aperto = fl ? 'open' : '';
  const id = 'at_' + slugify(attr.nome + '_' + Math.random());

  return {
    html: `
      <div class="node level-3">
        <div class="node-header" onclick="toggleNode('${id}')">
          <div class="node-toggle ${aperto}" id="tog_${id}">‚ñ∂</div>
          <div class="node-icon">‚öôÔ∏è</div>
          <div class="node-label">${hl(attr.nome, fl)}</div>
          <div class="node-count">${docsHtml.length}</div>
        </div>
        <div class="node-children ${aperto}" id="${id}">
          ${docsHtml.join('')}
        </div>
      </div>`,
    count: docsHtml.length
  };
}

function renderDoc(doc, fl) {
  const link = doc.link || '#';
  const target = link !== '#' ? 'target="_blank" rel="noopener"' : '';
  const sizeStr = doc.dimensione_kb ? formatSize(doc.dimensione_kb) : '';
  return `
    <a class="doc-row" href="${link}" ${target}>
      <span class="doc-icon">${doc.icona || 'üìé'}</span>
      <span class="doc-name">${hl(doc.nome, fl)}</span>
      <span class="doc-tipo">${doc.tipo || ''}</span>
      <span class="doc-size">${sizeStr}</span>
    </a>`;
}

// ‚îÄ‚îÄ TOGGLE NODI ‚îÄ‚îÄ
function toggleNode(id) {
  const el = document.getElementById(id);
  const tog = document.getElementById('tog_' + id);
  if (!el) return;
  const isOpen = el.classList.contains('open');
  el.classList.toggle('open', !isOpen);
  if (tog) tog.classList.toggle('open', !isOpen);
}

function espandiTutto() {
  document.querySelectorAll('.node-children').forEach(el => el.classList.add('open'));
  document.querySelectorAll('.node-toggle').forEach(el => el.classList.add('open'));
}

function collassaTutto() {
  document.querySelectorAll('.node-children').forEach(el => el.classList.remove('open'));
  document.querySelectorAll('.node-toggle').forEach(el => el.classList.remove('open'));
}

// ‚îÄ‚îÄ RICERCA LIVE ‚îÄ‚îÄ
let searchTimer = null;

function cercaLive(q) {
  clearTimeout(searchTimer);
  searchTimer = setTimeout(() => eseguiRicerca(q), 120);
}

function eseguiRicerca(q) {
  const query = q.trim().toLowerCase();
  const meta = document.getElementById('search-meta');
  const results = document.getElementById('search-results');

  if (!query) {
    meta.innerHTML = 'Digita per cercare in tutti i documenti';
    results.innerHTML = `<div class="placeholder"><div class="big">üîç</div><p>La ricerca trova clienti, attrezzature e nomi file<br>in tempo reale su tutto l'archivio</p></div>`;
    return;
  }

  const tokens = query.split(/\s+/).filter(Boolean);

  const trovati = TUTTI_DOCUMENTI.filter(doc => {
    const haystack = [doc.nome, doc._cliente, doc._area, doc._attrezzatura, doc._comune]
      .join(' ').toLowerCase();
    return tokens.every(t => haystack.includes(t));
  });

  meta.innerHTML = trovati.length
    ? `<b>${trovati.length}</b> risultat${trovati.length === 1 ? 'o' : 'i'} per "<b>${escHtml(q)}</b>"`
    : `Nessun risultato per "<b>${escHtml(q)}</b>"`;

  if (!trovati.length) {
    results.innerHTML = `<div class="placeholder"><div class="big">üì≠</div><p>Prova con termini diversi</p></div>`;
    return;
  }

  // Mostra max 200 risultati
  const slice = trovati.slice(0, 200);
  results.innerHTML = slice.map(doc => {
    const link = doc.link || '#';
    const target = link !== '#' ? 'target="_blank" rel="noopener"' : '';
    const sizeStr = doc.dimensione_kb ? formatSize(doc.dimensione_kb) : '';
    const pathParts = [doc._comune, doc._cliente, doc._area, doc._attrezzatura]
      .filter(Boolean)
      .map(p => `<span>${hlMulti(escHtml(p), tokens)}</span>`)
      .join('<span class="path-sep">/</span>');

    return `
      <a class="result-item" href="${link}" ${target}>
        <div class="result-icon">${doc.icona || 'üìé'}</div>
        <div class="result-body">
          <div class="result-name">${hlMulti(escHtml(doc.nome), tokens)}</div>
          <div class="result-path">${pathParts}</div>
        </div>
        <div class="result-right">
          <span class="result-tipo">${doc.tipo || ''}</span>
          <span class="result-size">${sizeStr}</span>
        </div>
      </a>`;
  }).join('');
}

// ‚îÄ‚îÄ TABS ‚îÄ‚îÄ
function switchTab(tab) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('view-' + tab).classList.add('active');
  document.getElementById('tab-' + tab).classList.add('active');

  if (tab === 'ricerca') {
    setTimeout(() => document.getElementById('search-input').focus(), 50);
  }
}

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ
function slugify(s) {
  return s.replace(/[^a-z0-9]/gi, '_').toLowerCase();
}

function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function hl(text, query) {
  if (!query) return escHtml(text);
  const escaped = escHtml(text);
  const re = new RegExp('(' + escRe(query) + ')', 'gi');
  return escaped.replace(re, '<mark>$1</mark>');
}

function hlMulti(text, tokens) {
  let out = text;
  for (const t of tokens) {
    const re = new RegExp('(' + escRe(t) + ')', 'gi');
    out = out.replace(re, '<mark>$1</mark>');
  }
  return out;
}

function escRe(s) {
  return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

function formatSize(kb) {
  if (kb >= 1024) return (kb / 1024).toFixed(1) + ' MB';
  return kb + ' KB';
}

// ‚îÄ‚îÄ START ‚îÄ‚îÄ
init();
</script>
</body>
</html>
